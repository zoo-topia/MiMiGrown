<div data-section-type="cart-template" data-ajax-update="true">
  <div class="page-header">
    <h1 class="majortitle">{{ 'cart.general.title' | t }}</h1>
  </div>

  {% if cart.items == empty %}
    <div class="row-spacing align-centre">
      <p>{{ 'cart.general.empty' | t }}</p>
    </div>
  {% else %}
    {% render 'banana-stand-cart-top-container' %}

    <form action="/cart" method="post" id="cartform">
      <div class="cart-item-list content-divider">
        <div class="cart-item-list__head">
          <div class="cart-item-list-heading cart-item-list-heading--product">{{ 'cart.label.product' | t }}</div>
          <div class="cart-item-list-heading cart-item-list-heading--price">{{ 'cart.label.price' | t }}</div>
          <div class="cart-item-list-heading cart-item-list-heading--quantity">{{ 'cart.label.quantity' | t }}</div>
          <div class="cart-item-list-heading cart-item-list-heading--total">{{ 'cart.label.total' | t }}</div>
        </div>
        <div class="cart-item-list__body">
          {% for item in cart.items %}
            <div class="cart-item product-{{ item.product.handle }}">
              {%- comment -%}
              Determining the handle of the collection that was last seen for the 'continue shopping' link.
              {%- endcomment -%}

              {%- if forloop.first -%}
                {%- capture collection_url -%}{{ item.product.collections.first.url }}{%- endcapture -%}
                {%- if collection_url == empty or collection_url == '/collections/frontpage' -%}{%- assign collection_url = '/collections/all' -%}{%- endif -%}
              {%- endif -%}

              <div class="cart-item__column cart-item__image">
                <a href="{{ item.url }}">
                  {% include 'responsive-image', image: item.image, max_height: 100 %}
                </a>
              </div>

              <div class="cart-item__not-image">
                <div class="cart-item__column cart-item__description">
                  <div>
                    <a class="name" href="{{ item.url }}">{{ item.product.title }}</a>
                    {% if item.product.variants.size > 1 %}
                    <div class="variant">{{ item.variant.title }}</div>
                    {% endif %}

                    {% if item.variant.inventory_management == 'shopify' and item.variant.inventory_quantity < 1 %}
                    <div class="backorder">
                      <p>{{ 'cart.general.backorder' | t }}</p>
                    </div>
                    {% endif %}
                  </div>

                  {%- for p in item.properties -%}
                    {% unless p.last == blank %}
                      <span class="custom">{{ p.first }}:
                        {% if p.last contains '/uploads/' %}
                        <a href="{{ p.last }}">{{ p.last | split: '/' | last }}</a>
                        {% else %}
                        {{ p.last }}
                        {% endif %}
                      </span>
                    {% endunless %}
                  {%- endfor -%}
                </div>

                <div class="cart-item__column cart-item__price">
                  {% if item.original_line_price > item.final_line_price %}
                    <div class="struck-out-price"><span class="theme-money">{{ item.original_price | money }}</span></div>
                  {% endif %}
                  <div><span class="theme-money">{{ item.final_price | money }}</span></div>
                  {% if item.line_level_discount_allocations.size > 0 %}
                    <ul class="cart-discount-list">
                    {% for discount_allocation in item.line_level_discount_allocations %}
                      <li class="cart-discount">
                        <div class="cart-discount__label">
                            <span class="cart-discount__icon">{% include 'icon-label' %}</span>
                            <span class="cart-discount__title">{{ discount_allocation.discount_application.title }}</span>
                        </div>
                        <div class="cart-discount__amount theme-money">{{ discount_allocation.amount | money }}</div>
                      </li>
                    {% endfor %}
                    </ul>
                  {% endif %}
                </div>

                {% if item.variant.inventory_management == 'shopify' and item.variant.inventory_policy == 'deny' and item.variant.inventory_quantity <= item.quantity %}
                  {% assign can_increase = false %}
                {% else %}
                  {% assign can_increase = true %}
                {% endif %}
                <div class="cart-item__column cart-item__quantity">
                  <div class="quantity buttoned-input">
                    <a id="updates_dec_{{ forloop.index }}" class="notabutton quantity-down {% if item.quantity < 2 %}unusable{% endif %}" href="/cart/change?line={{ forloop.index }}&quantity={{ item.quantity | minus: 1 }}" aria-label="{{ 'cart.label.decrease' | t | escape }}">{% include 'svg-minus' %}</a>
                    <input
                      class="cart-item__quantity-input"
                      type="text"
                      size="2"
                      id="updates_{{ forloop.index }}"
                      name="updates[]"
                      value="{{ item.quantity }}"
                      data-initial-value="{{ item.quantity }}"
                      data-line="{{ forloop.index }}"
                      {% if item.variant.inventory_management == 'shopify' and item.variant.inventory_policy == 'deny' %}data-max="{{ item.variant.inventory_quantity }}"{% endif %}
                      aria-label="{{ 'cart.general.quantity' | t | escape }}" />
                    <a id="updates_inc_{{ forloop.index }}" class="notabutton quantity-up {% unless can_increase %}unusable{% endunless %}" href="/cart/change?line={{ forloop.index }}&quantity={{ item.quantity | plus: 1 }}" aria-label="{{ 'cart.label.increase' | t | escape }}">{% include 'svg-plus' %}</a>
                  </div>
                  <a class="remove" onclick="return confirm('{{ 'cart.general.confirm_remove' | t }}')" href="/cart/change?line={{ forloop.index }}&quantity=0">
                    {{ 'cart.general.remove' | t }}
                    {% include 'svg-x' %}
                  </a>
                </div>

                <div class="cart-item__column cart-item__total" data-line="{{ forloop.index }}">
                  {% if item.original_line_price != item.final_line_price %}
                    <div class="theme-money struck-out-price">{{ item.original_line_price | money }}</div>
                    <span class="theme-money">{{ item.final_line_price | money }}</span>
                  {% else %}
                    <span class="theme-money">{{ item.final_line_price | money }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="checkout-subtotal-container">
        <div class="checkout-subtotal-container__left layout-column-half-left">
          {% if section.settings.enable_cart_notes %}
            <div class="checkout-note">
              <label for="note">{{ 'cart.label.note' | t }}</label>
              <div class="textareawrapper"><textarea id="note" name="note">{{ cart.note }}</textarea></div>
            </div>
          {% endif %}

          {% if section.settings.show_shipping_calculator %}
            <button class="notabutton" data-toggle-shipping data-toggle-html="{{ 'cart.shipping_calculator.button_hide' | t | escape }}">{{ 'cart.shipping_calculator.button_show' | t }}</button>
            {% include 'shipping-calculator', default_country: section.settings.shipping_calculator_default_country %}
          {% endif %}
        </div>

        <div class="checkout-subtotal-container__right layout-column-half-right">
          {%- if cart.cart_level_discount_applications != blank -%}
            <ul class="cart-discount-list">
              {%- for discount_application in cart.cart_level_discount_applications -%}
                <li class="cart-discount cart-discount--inline">
                  <span class="cart-discount__label">
                      <span class="cart-discount__icon">{% include 'icon-label' %}</span>
                      <span class="cart-discount__title">{{ discount_application.title }}</span>
                  </span>
                  <span class="cart-discount__amount theme-money">{{ discount_application.total_allocated_amount | money }}</span>
                </li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
          <h2 class="subtotal h2-style">
            {{ 'cart.general.subtotal' | t }}
            <span class="theme-money">{{ cart.total_price | money }}</span>
          </h2>

          <div>{{ 'cart.general.message' | t }}</div>

          {% if section.settings.cart_terms_page != blank %}
            <div class="termsagreement">
              <input type="checkbox" id="terms" />
              {% assign terms_url = pages[section.settings.cart_terms_page].url %}
              <label for="terms">{{ 'cart.terms.agreement_html' | t: terms_url: terms_url }}</label>
            </div>
          {% endif %}

          <div class="checkout-col">
            <div class="checkout-buttons">
              <div class="update-cart-container">
                <input type="submit" class="notabutton" name="update" value="{{ 'cart.general.update' | t }}" /> {{ 'cart.general.or' | t }}
              </div>

              <input type="submit" class="button button--large" id="update-cart" name="checkout" value="{{ 'cart.general.checkout' | t }}" />

              {% if additional_checkout_buttons and section.settings.cart_terms_page == blank %}
              <div class="additional-checkout-buttons">
                {{ content_for_additional_checkout_buttons }}
              </div>
              {% endif %}
            </div>

            <a class="continue-shopping" href="{{ collection_url }}">{{ 'cart.general.continue' | t }}</a>
          </div>
        </div>
      </div>
    </form>
  {% endif %}
</div>


{% schema %}
  {
    "name": "Cart page",
    "settings": [
    {
        "type": "checkbox",
        "id": "enable_cart_notes",
        "label": "Enable cart notes",
        "default": false
      },
      {
        "type": "page",
        "id": "cart_terms_page",
        "label": "Page for Terms and Conditions link",
        "info": "Additional checkout buttons will be hidden when cart terms are shown"
      },
      {
        "type": "header",
        "content": "Shipping rates calculator"
      },
      {
        "type": "checkbox",
        "id": "show_shipping_calculator",
        "label": "Show",
        "default": false
      },
      {
        "type": "text",
        "id": "shipping_calculator_default_country",
        "label": "Default country selection",
        "default": "United States"
      },
      {
        "type": "paragraph",
        "content": "If your customer is logged-in, the country in his default shipping address will be selected. If you are not sure about the spelling to use here, refer to your first checkout page dropdown."
      }
  ]
  }
{% endschema %}

<!-- Begin Shopify-Afterpay JavaScript MutationObserver Configuration -->

<script type="text/javascript">
  window.addEventListener('load', () =>  {
    const cartTargetNode = document.querySelector('#cartform');
    let cartConfig = { characterData: true, attributes: true, childList: true, subtree: true };
      const cartCallback = (mutationsList, observer) => {     
        const subtotalSpan = document.querySelector('.subtotal > .theme-money');
        document.querySelector('p.afterpay-paragraph') && document.querySelector('p.afterpay-paragraph').remove();
        const newSubtotal = Number(subtotalSpan.textContent.replace(/[^0-9 ]/g, ''));
        afterpay_cart_total_price = subtotalSpan.textContent.includes('.') ? newSubtotal : newSubtotal * 100;
        Afterpay.init($);
        observer.takeRecords();
      };
    
    const cartObserver = new MutationObserver(cartCallback);
    cartObserver.observe(cartTargetNode, cartConfig);    
  });
</script>

<!-- End Shopify-Afterpay JavaScript MutationObserver Configuration -->